<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š ç•¢æ¥­æ—…è¡Œæ„é¡˜çµ±è¨ˆçµæœ</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
    </style>
    <!-- Load Google Charts Library -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body class="p-4 sm:p-8 min-h-screen flex flex-col items-center">

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 sm:p-10 border-t-8 border-green-500">
        
        <!-- Header -->
        <header class="mb-10 text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-green-700 mb-2">
                ğŸ“Š åœ‹å…§ç•¢æ—…æ„é¡˜çµ±è¨ˆæ¦‚è¦½
            </h1>
            <p id="totalSubmissions" class="text-gray-600 text-lg font-semibold"></p>
        </header>

        <!-- Loading Indicator / Error Message -->
        <div id="statusMessage" class="flex justify-center items-center h-48">
            <svg class="animate-spin h-8 w-8 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-3 text-gray-500">æ­£åœ¨è¼‰å…¥çµ±è¨ˆæ•¸æ“š...</span>
        </div>

        <!-- Chart Containers -->
        <div id="chartContainers" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Duration Chart (Pie Chart) -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-lg border border-gray-200">
                <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">åå¥½çš„æ—…è¡Œå¤©æ•¸ (å¤©æ•¸)</h2>
                <div id="duration_chart" class="h-80 w-full"></div>
            </div>

            <!-- Time Chart (Bar Chart) -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-lg border border-gray-200">
                <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">æ–¹ä¾¿çš„æ—…éŠæ™‚é–“é¸é … (æ™‚é–“)</h2>
                <div id="time_chart" class="h-80 w-full"></div>
            </div>
            
        </div>
        
        <!-- Raw Data Display Placeholder (Optional, for reference) -->
        <div class="mt-8 pt-4 border-t border-gray-200">
             <h2 class="text-xl font-bold text-gray-700 mb-3">åœ°é»è¨±é¡˜åˆ—è¡¨ (å‰äº”å)</h2>
             <ul id="location_list" class="space-y-1 text-gray-700">
                 <!-- Location results will be inserted here -->
             </ul>
        </div>

    </div>

    <script>
        // IMPORTANT: PLEASE USE THE SAME DEPLOYED GOOGLE APPS SCRIPT URL HERE
        // è«‹å‹™å¿…æ›¿æ›æˆæ‚¨çš„ Google Apps Script åŸ·è¡Œç¶²å€ (çµå°¾å¿…é ˆæ˜¯ /exec)
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzcVCT7e3XyXc6F7xX7Zbonfk-R-O1pQA2zte3_KnDgL9BA4fRTKR-uiDdZF5X24RvXpQ/exec"; 

        // Load the Visualization API and the corechart package.
        google.charts.load('current', {'packages':['corechart', 'bar']});
        
        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(fetchAndDrawCharts);
        
        const statusMessage = document.getElementById('statusMessage');
        const chartContainers = document.getElementById('chartContainers');
        const totalSubmissionsElement = document.getElementById('totalSubmissions');

        // Function to fetch data from the Apps Script GET endpoint (FIXED for non-JSON responses)
        async function fetchData() {
            // **FIX/Diagnostic: Check for /dev URL which causes "Failed to fetch"**
            if (GOOGLE_SCRIPT_URL.endsWith("/dev")) {
                statusMessage.innerHTML = '<span class="text-red-500 font-bold">âŒ **éƒ¨ç½² URL éŒ¯èª¤ï¼š** æ‚¨ç›®å‰ä½¿ç”¨çš„æ˜¯ Google Apps Script çš„ **/dev** é–‹ç™¼æ¨¡å¼ç¶²å€ã€‚æ­¤ç¶²å€ä¸æ”¯æ´å…¬é–‹å­˜å–ï¼Œæœƒå°è‡´ã€ŒFailed to fetchã€éŒ¯èª¤ã€‚<br>è«‹å‹™å¿…ä½¿ç”¨**åŸ·è¡Œç¶²å€**ï¼ˆçµå°¾ç‚º **/exec**ï¼‰ä¸¦ç¢ºèªéƒ¨ç½²å­˜å–æ¬Šç‚º**ã€Œä»»ä½•äººã€**ã€‚</span>';
                return null;
            }

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'GET' });
                
                // è®€å–åŸå§‹æ–‡å­—ï¼Œé¿å…ç›´æ¥ä½¿ç”¨ .json() åœ¨é JSON éŸ¿æ‡‰æ™‚æ‹‹å‡ºéŒ¯èª¤
                const rawText = await response.text();

                // æª¢æŸ¥æ˜¯å¦ç‚ºéŒ¯èª¤è¨Šæ¯æˆ–é JSON çš„èˆŠç‰ˆå›è¦†
                if (!response.ok || rawText.startsWith("Error") || rawText.startsWith("This")) {
                    console.error("ä¼ºæœå™¨å›æ‡‰é JSON æˆ–ç‹€æ…‹é 200:", rawText);
                    
                    // åˆ¤æ–·æ˜¯å¦ç‚º Apps Script çš„é è¨­éŒ¯èª¤è¨Šæ¯ (æ ¹æºï¼šdoGetæœªæ›´æ–°)
                    if (rawText.startsWith("This endpoint only accepts POST requests.")) {
                         statusMessage.innerHTML = '<span class="text-red-500 font-bold">âŒ **ä¼ºæœå™¨è¨­å®šéŒ¯èª¤ï¼š** Google Apps Script å°šæœªæ­£ç¢ºéƒ¨ç½²ç‚º JSON APIã€‚<br>è«‹ç¢ºèªæ‚¨å·²å°‡æœ€æ–°çš„ `Code.gs` è²¼ä¸Šä¸¦åŸ·è¡Œ**é‡æ–°éƒ¨ç½²**ï¼ˆå­˜å–æ¬Šéœ€è¨­å®šç‚ºã€Œä»»ä½•äººã€ï¼‰ã€‚</span>';
                    } else {
                         statusMessage.innerHTML = `<span class="text-red-500 font-bold">âŒ è¼‰å…¥æ•¸æ“šå¤±æ•—ã€‚ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ï¼š${rawText.substring(0, 80)}...</span>`;
                    }
                    return null;
                }
                
                // å˜—è©¦è§£æ JSON
                const data = JSON.parse(rawText); 
                return data;

            } catch (error) {
                console.error("Error fetching data:", error);
                // This catch now handles generic fetch errors like CORS/network issues
                statusMessage.innerHTML = '<span class="text-red-500 font-bold">âŒ è¼‰å…¥æ•¸æ“šå¤±æ•— (Failed to fetch)ã€‚é€™å¯èƒ½æ˜¯ç”±æ–¼ **CORS æ¬Šé™å•é¡Œ** æˆ– **ç¶²è·¯é€£ç·šéŒ¯èª¤**ã€‚è«‹å†æ¬¡ç¢ºèª Apps Script éƒ¨ç½²çš„å­˜å–æ¬Šæ˜¯å¦ç‚º**ã€Œä»»ä½•äººã€**ã€‚</span>';
                return null;
            }
        }

        // Function to draw the charts
        async function fetchAndDrawCharts() {
            const data = await fetchData();
            
            if (!data || data.error) {
                // statusMessage å·²ç¶“åœ¨ fetchData ä¸­è™•ç†
                return;
            }

            statusMessage.classList.add('hidden');
            chartContainers.classList.remove('hidden');
            
            totalSubmissionsElement.textContent = `ï¼ˆå·²æ”¶åˆ° ${data.totalSubmissions} ä»½å›è¦†ï¼‰`;
            
            // --- ç¹ªè£½å¤©æ•¸åœ“é¤…åœ– ---
            drawDurationChart(data.duration);
            
            // --- ç¹ªè£½æ™‚é–“é•·æ¢åœ– ---
            drawTimeChart(data.time);
            
            // --- ç¹ªè£½åœ°é»åˆ—è¡¨ï¼ˆç°¡åŒ–ç‰ˆï¼Œåªé¡¯ç¤ºå‰äº”åï¼‰ ---
            // ç”±æ–¼ Apps Script çš„ doGet å°ˆæ³¨æ–¼å¤©æ•¸å’Œæ™‚é–“ï¼Œåœ°é»éœ€è¦é¡å¤–è™•ç†
            // åœ¨é€™è£¡å…ˆé¡¯ç¤ºä¸€å€‹å‹å–„çš„æç¤ºï¼Œè®“ä½¿ç”¨è€…çŸ¥é“å¦‚ä½•æŸ¥çœ‹åœ°é»
            document.getElementById('location_list').innerHTML = 
                 `<li class="text-base text-indigo-600 font-medium">è«‹ç›´æ¥æŸ¥çœ‹ Google Sheet ç²å¾—å®Œæ•´ã€Œåœ°é»ã€å’Œã€Œåƒè€ƒç¶²å€/è¡Œç¨‹ã€çš„å»ºè­°ã€‚</li>`;
        }

        function drawDurationChart(durationData) {
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'å¤©æ•¸');
            dataTable.addColumn('number', 'ç¥¨æ•¸');
            
            // Convert count object to array of arrays
            const rows = Object.entries(durationData);
            dataTable.addRows(rows);

            const options = {
                title: 'åå¥½çš„æ—…è¡Œå¤©æ•¸åˆ†ä½ˆ',
                pieHole: 0.4,
                legend: { position: 'bottom' },
                colors: ['#3b82f6', '#f59e0b', '#ef4444', '#10b981'], // Tailwind-inspired colors
                chartArea: { width: '90%', height: '80%' }
            };

            const chart = new google.visualization.PieChart(document.getElementById('duration_chart'));
            chart.draw(dataTable, options);
        }

        function drawTimeChart(timeData) {
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'æ™‚é–“é¸é …');
            dataTable.addColumn('number', 'ç¥¨æ•¸');

            // Sort data to make the bar chart more readable (e.g., by week order)
            const timeOrder = [
                "5æœˆç¬¬ä¸€é€± (å‹å‹•ç¯€)", "5æœˆç¬¬äºŒé€±", "5æœˆç¬¬ä¸‰é€±", "5æœˆç¬¬å››é€±", 
                "æ™‚é–“éƒ½å¯ä»¥", "å…¶ä»–æ™‚é–“", "æœªå¡«å¯«"
            ];
            
            const rows = timeOrder
                .map(key => [key, timeData[key] || 0])
                .filter(row => row[1] > 0); // Only include options that received votes
            
            dataTable.addRows(rows);

            const options = {
                title: 'æ—…éŠæ™‚é–“æŠ•ç¥¨çµæœ',
                legend: { position: 'none' },
                hAxis: { title: 'ç¥¨æ•¸', minValue: 0 },
                vAxis: { title: 'æ™‚é–“é¸é …' },
                colors: ['#059669'], // Green color for success/go
                chartArea: { width: '65%', height: '80%' }
            };

            const chart = new google.visualization.BarChart(document.getElementById('time_chart'));
            chart.draw(dataTable, options);
        }

    </script>
</body>
</html>
